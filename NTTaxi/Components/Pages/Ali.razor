@page "/ali"
@using NTTaxi.Libraries.Models.Gsms

@if (!loaded_form)
{
    <div class="flex min-h-screen items-center justify-center text-sm text-teal-700">@loadedForm_string</div>
}
else
{
    <div class="mt-2 w-full">
        <div class="mt-2">
            <div class="flex bg-gray-900 p-2 text-gray-100">
                <div class="mb-4 text-2xl font-bold text-green-400">ALI Control Panel</div>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-4 bg-gray-900 p-4 text-gray-100">
            <div>
                <label class="px-2">Tài khoản:</label>
                <input class="rounded border border-gray-600 bg-gray-800 px-2 py-1 text-gray-100"
                       @bind="userAli.username" />
            </div>
            <div>
                <label class="px-2">Mật khẩu:</label>
                <input type="password"
                       class="rounded border border-gray-600 bg-gray-800 px-2 py-1 text-gray-100"
                       @bind="userAli.password" />
            </div>
            <button class="rounded-xl bg-green-500 px-2 py-1 text-sm text-white hover:bg-green-600 disabled:cursor-not-allowed disabled:bg-gray-500"
                    @onclick="Login" disabled="@isLoading">
                @(isLoading ? "Đang đăng nhập..." : "Đăng nhập")
            </button><span class="text-teal-700">@authenStatus</span>
        </div>
        <div class="mt-2">
            <div class="flex flex-wrap items-center gap-4 bg-gray-900 p-4 text-gray-100">
                <div>
                    <label class="px-2">Bắt đầu:</label>
                    <input type="datetime"
                           class="rounded border border-gray-600 px-2 py-1"
                           @bind="startDate" />
                </div>
                <div>
                    <label class="px-2">Kết thúc:</label>
                    <input type="datetime"
                           class="rounded border border-gray-600 px-2 py-1"
                           @bind="endDate" />
                </div>
                <button class="rounded-xl bg-green-500 px-2 py-1 text-sm text-white hover:bg-green-600 disabled:cursor-not-allowed disabled:bg-gray-500"
                        @onclick="(() => AppendGoogleSheetAsync())" disabled="@isGetsRecording">
                    @(isGetsRecording ? "Đang lấy dữ liệu..." : "Ghi dữ liệu")
                </button><span class="text-teal-700">@saveGGSheet</span>
            </div>
        </div>

        @if (orders == null)
        {
            <p>Đang tải dữ liệu...</p>
        }
        else if (!orders.Any())
        {
            <p>Chưa có đơn hàng nào.</p>
        }
        else
        {
            <div class="my-3">
                Tổng cuốc: (5/@orders.Count)
                <a href="https://docs.google.com/spreadsheets/d/1rMB8_QIkPG_rJWF_4sph9YPjTqNQ7XIWfzkGWzWVM1k/edit?gid=777025477#gid=777025477"
                   target="_blank" class="text-blue-500 underline hover:text-blue-700">
                    Chi tiết
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-100">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Số Tài</th>
                            <th class="px-4 py-2 text-left">KM</th>
                            <th class="px-4 py-2 text-left">Giá</th>
                            <th class="px-4 py-2 text-left">Thời gian đặt</th>
                            <th class="px-4 py-2 text-left">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        @foreach (var order in orders.Take(5))
                        {
                            <tr class="hover:bg-gray-700">
                                <td class="px-4 py-2">@order.ID</td>
                                <td class="px-4 py-2">@order.DriveNo</td>
                                <td class="px-4 py-2">@order.Distance</td>
                                <td class="px-4 py-2">@order.Price</td>
                                <td class="px-4 py-2">@order.BookingTime</td>
                                <td class="px-4 py-2">@order.Status</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        @if (promotes != null)
        {
            <div class="my-3">
                Tổng khuyến mãi: (5/@promotes.Count)
                <a href="https://docs.google.com/spreadsheets/d/1rMB8_QIkPG_rJWF_4sph9YPjTqNQ7XIWfzkGWzWVM1k/edit?gid=2041033965#gid=2041033965"
                   target="_blank" class="text-blue-500 underline hover:text-blue-700">
                    Chi tiết
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-100">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Mã đối tác</th>
                            <th class="px-4 py-2 text-left">SĐT tài xế</th>
                            <th class="px-4 py-2 text-left">Giá</th>
                            <th class="px-4 py-2 text-left">Giảm giá</th>
                            <th class="px-4 py-2 text-left">Ngày</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        @foreach (var promote in promotes.Take(5))
                        {
                            <tr class="hover:bg-gray-700">
                                <td class="px-4 py-2">@promote.ID</td>
                                <td class="px-4 py-2">@promote.PartnerCode</td>
                                <td class="px-4 py-2">@promote.DriverPhoneNumber</td>
                                <td class="px-4 py-2">@promote.Price</td>
                                <td class="px-4 py-2">@promote.PromotionPrice</td>
                                <td class="px-4 py-2">@promote.CreatedAt</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (cancelOrders != null)
        {
            <div class="my-3">
                Tổng cuốc hủy: (5/@cancelOrders.Count())
                <a href="https://docs.google.com/spreadsheets/d/1rMB8_QIkPG_rJWF_4sph9YPjTqNQ7XIWfzkGWzWVM1k/edit?gid=1425231531#gid=1425231531"
                   target="_blank" class="text-blue-500 underline hover:text-blue-700">
                    Chi tiết
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-100">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Số Tài</th>
                            <th class="px-4 py-2 text-left">KM</th>
                            <th class="px-4 py-2 text-left">Giá</th>
                            <th class="px-4 py-2 text-left">Thời gian đặt</th>
                            <th class="px-4 py-2 text-left">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        @foreach (var cancel in cancelOrders.Take(5))
                        {
                            <tr class="hover:bg-gray-700">
                                <td class="px-4 py-2">@cancel.ID</td>
                                <td class="px-4 py-2">@cancel.DriveNo</td>
                                <td class="px-4 py-2">@cancel.Distance</td>
                                <td class="px-4 py-2">@cancel.Price</td>
                                <td class="px-4 py-2">@cancel.BookingTime</td>
                                <td class="px-4 py-2">@cancel.Status</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (switchBoards != null)
        {
            <div class="my-3">
                Tổng cuốc tổng đài: (5/@switchBoards.Count())
                <a href="https://docs.google.com/spreadsheets/d/1rMB8_QIkPG_rJWF_4sph9YPjTqNQ7XIWfzkGWzWVM1k/edit?gid=1491480516#gid=1491480516"
                   target="_blank" class="text-blue-500 underline hover:text-blue-700">
                    Chi tiết
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-100">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Số Tài</th>
                            <th class="px-4 py-2 text-left">KM</th>
                            <th class="px-4 py-2 text-left">Giá</th>
                            <th class="px-4 py-2 text-left">Thời gian đặt</th>
                            <th class="px-4 py-2 text-left">Cuốc xe từ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        @foreach (var sb in switchBoards.Take(5))
                        {
                            <tr class="hover:bg-gray-700">
                                <td class="px-4 py-2">@sb.ID</td>
                                <td class="px-4 py-2">@sb.DriveNo</td>
                                <td class="px-4 py-2">@sb.Distance</td>
                                <td class="px-4 py-2">@sb.Price</td>
                                <td class="px-4 py-2">@sb.BookingTime</td>
                                <td class="px-4 py-2">@sb.Note</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (partnerGSMs != null)
        {
            <div class="my-3">
                Tổng cuốc đối tác GSM: (5/@partnerGSMs.Count())
                <a href="https://docs.google.com/spreadsheets/d/1rMB8_QIkPG_rJWF_4sph9YPjTqNQ7XIWfzkGWzWVM1k/edit?gid=521893464#gid=521893464"
                   target="_blank" class="text-blue-500 underline hover:text-blue-700">
                    Chi tiết
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 bg-gray-900 text-gray-100">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-4 py-2 text-left">ID ĐỐI TÁC</th>
                            <th class="px-4 py-2 text-left">ID HỆ THỐNG</th>
                            <th class="px-4 py-2 text-left">Số tài</th>
                            <th class="px-4 py-2 text-left">KM</th>
                            <th class="px-4 py-2 text-left">Giá</th>
                            <th class="px-4 py-2 text-left">Thời gian đặt</th>
                            <th class="px-4 py-2 text-left">Cuốc xe từ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        @foreach (var partner in partnerGSMs.Take(5))
                        {
                            <tr class="hover:bg-gray-700">
                                <td class="px-4 py-2">@partner.Id_partner</td>
                                <td class="px-4 py-2">@partner.Id_ali</td>
                                <td class="px-4 py-2">@partner.DriveNo</td>
                                <td class="px-4 py-2">@partner.Distance</td>
                                <td class="px-4 py-2">@partner.Price</td>
                                <td class="px-4 py-2">@partner.TripTime</td>
                                <td class="px-4 py-2">@partner.PickupLocation</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    [Inject] private IAliService aliService { get; set; } = default!;
    private bool loaded_form = false;
    private bool isLoading = false;
    private bool isGetsRecording = false;
    private string authenStatus = "";
    private string loadedForm_string = "Đang tải...";
    private string saveGGSheet = "";

    private DateTime startDate { get; set; } = DateTime.Now.AddDays(-1).Date.AddHours(5);
    private DateTime endDate { get; set; } = DateTime.Now.Date.AddHours(5);
    private UserAli userAli { get; set; } = new UserAli();
    private List<OrderAli> orders { get; set; } = new List<OrderAli>();
    private List<PromoteAli> promotes { get; set; } = new List<PromoteAli>();
    private List<CancelOrder> cancelOrders { get; set; } = new List<CancelOrder>();
    private List<SwitchboardAli> switchBoards { get; set; } = new List<SwitchboardAli>();
    private List<PartnerGSM> partnerGSMs { get; set; } = new List<PartnerGSM>();
    private SchemaJson schemaJson { get; set; } = new SchemaJson();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            schemaJson = JsonSerializer.Deserialize<SchemaJson>(await File.ReadAllTextAsync("AliAuthentication.json"));

            if (schemaJson != null)
            {
                userAli = new UserAli
                {
                    username = schemaJson.User.username,
                    password = schemaJson.User.password,
                };

                orders = await aliService.GetsOrderAli(schemaJson, startDate, endDate);
                //promotes = await aliService.GetsPromoteAli(schemaJson, startDate, endDate);
                //cancelOrders = await aliService.GetsCancelOrderAli(startDate, endDate); //Hiển thị cho client
                //switchBoards = await aliService.GetsSwitchboardAli(startDate, endDate);
                //partnerGSMs = await aliService.GetsPartnerGSMAli(startDate, endDate);
                await aliService.PostPartnerVNPayAli(startDate, endDate);
                loaded_form = true;
            }
            else
            {
                loadedForm_string = "Không tìm thấy file AliAuthenticaion!";
            }
        }
        catch (Exception ex)
        {
            authenStatus = $"{ex.Message}";
        }
    }

    private async Task Login()
    {
        try
        {
            isLoading = true; // Disable button
            bool success = await aliService.GetAuthenticationAsync(userAli);
            authenStatus = success ? "Đăng nhập thành công, đã ghi nhớ tài khoản!" : "Tài khoản đăng nhập không đúng vui lòng nhập lại!";
        }
        catch (Exception ex)
        {
            authenStatus = "Đăng nhập thất bại, vui lòng nhập lại!";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false; // Enable button sau khi xử lý xong
        }
    }

    private async Task TestGoogleAppen()
    {
        try
        {
            isGetsRecording = true; // Disable button
            await aliService.PostOrderAli(schemaJson, startDate, endDate);
            //orders = await aliService.GetsOrderAli(schemaJson, startDate, endDate);
        }
        catch (Exception ex)
        {
            saveGGSheet = $"Lỗi: {ex.Message}";
        }
        finally
        {
            isGetsRecording = false; // Enable button sau khi xử lý xong
        }
    }

    private async Task AppendGoogleSheetAsync()
    {
        try
        {
            isGetsRecording = true; // Disable button
            await aliService.PostOrderAli(schemaJson, startDate, endDate); 
            //orders = await aliService.GetsOrderAli(schemaJson, startDate, endDate); 

            await aliService.PostPromoteAli(schemaJson, startDate, endDate);
            //promotes = await aliService.GetsPromoteAli(schemaJson, startDate, endDate);

            await aliService.PostCancelOrderAli(startDate, endDate);
            //cancelOrders = await aliService.GetsCancelOrderAli( startDate, endDate); 

            await aliService.PostSwitchboardAli(startDate, endDate);
            //switchBoards = await aliService.GetsSwitchboardAli(startDate, endDate);

            await aliService.PostPartnerGSMAli(startDate, endDate);
            //partnerGSMs = await aliService.GetsPartnerGSMAli(startDate, endDate);

            await aliService.PostPartnerVNPayAli(startDate, endDate);

            await aliService.PostOnlineAppAli(schemaJson, startDate, endDate);

            saveGGSheet = $"Ghi dữ liệu thành công";
        }
        catch (Exception ex)
        {
            saveGGSheet = $"Lỗi: {ex.Message}";
        }
        finally
        {
            isGetsRecording = false; // Enable button sau khi xử lý xong
        }
    }
}